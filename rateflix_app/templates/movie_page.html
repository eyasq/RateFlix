{% extends 'base.html' %}
{% block title %}Movie Details{% endblock %}
{% block content %}

<div class="container mt-4">
  <div class="row">
    <div class="col-md-4 mb-4">
      <div class="card">
        <img src="https://image.tmdb.org/t/p/w600_and_h900_bestv2/{{ movie.poster_path }}" class="card-img-top" alt="{{ movie.title }}">
        <div class="card-body">
          <small class="text-muted">{{ movie.release_date|slice:":4" }}</small>
          <h4 class="card-title">{{ movie.title }}</h4>
          <p><strong>ID:</strong> {{ movie.id }}</p>
          <p class="card-text">{{ movie.overview }}</p>

          {% if user.is_authenticated %}
            {% if movie.id in user_favorite_ids %}
              <button class="btn btn-warning mt-2" disabled>★ Favorited</button>
            {% else %}
              <form method="POST" action="#">
                {% csrf_token %}
                {% if movie.id in user_favorites %}
                <button type="submit" class="btn mt-2 favorite-btn favorited" data-movie-id="{{movie.id}}" data-movie-title="{{movie.title}}" data-movie-poster="{{movie.poster_path}}">★ Favorited</button>
              {% else %}
              <button type="submit" class="btn mt-2 favorite-btn" data-movie-id="{{movie.id}}" data-movie-title="{{movie.title}}" data-movie-poster="{{movie.poster_path}}">★ Add to Favorites</button>
              {% endif %}
 
              </form>
            {% endif %}
          {% endif %}
          <!-- add to favorites logic -> should be done using AJAX. When a user adds a movie to the favorites, check if a movice instance exists in DB, if not, make one, then add the movie instance to the users favorites. must add javascript code for async handling no refresh, and a view function to handle this. -->
        </div>
      </div>
    </div>

    <div class="col-md-8 mb-4">
      {% if user.is_authenticated %}
        <h5>Add a Review</h5>
        <form method="POST" id="reviewForm" action="{% url 'submit_review' %}">
          {% csrf_token %}
          <div class="form-group mb-2">
            <select name="rating" class="form-control">
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3" selected>3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
          </div>
          <div class="form-group mb-2">
            <textarea name="review" class="form-control" id="reviewText" rows="3" placeholder="Write your review..."></textarea>
          </div>
          <button type="submit" name="submit_review" class="btn btn-primary submit_review">Submit Review</button>
        </form>
        <div id="reviewMessage"></div>
        <hr>
      {% endif %}

      <h5>Reviews</h5>
      <div>
        {% if reviews %}
          {% for review in reviews.all %}
            <div class="border p-2 rounded mb-2">
              <strong>{{ review.user.username }}</strong>:
              <p class="mb-0">{{ review.text }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No reviews yet.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <h4>Top Cast</h4>
      <div class="row">
        {% for actor in cast %}
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
          <div class="card h-100 text-center">
            {% if actor.profile_path %}
              <img src="https://image.tmdb.org/t/p/w300{{ actor.profile_path }}" class="card-img-top" alt="{{ actor.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x450?text=No+Image" class="card-img-top" alt="{{ actor.name }}">
            {% endif %}
            <div class="card-body p-2">
              <h6 class="card-title mb-1">{{ actor.name }}</h6>
              <p class="card-text text-muted mb-0" style="font-size: 0.8rem;">{{ actor.character }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <h4>Comments</h4>

      {% if user.is_authenticated %}
        <form method="POST" action="">
          {% csrf_token %}
          <div class="form-group mb-2">
            <textarea name="comment" class="form-control" rows="2" placeholder="Add a comment..."></textarea>
          </div>
          <button type="submit" name="submit_comment" class="btn btn-secondary">Post Comment</button>
        </form>
        <hr>
      {% endif %}

      <div>
        {% if comments %}
          {% for comment in comments.all %}
            <div class="border p-2 rounded mb-2">
              <strong>{{ comment.user.username }}</strong>:
              <p class="mb-0">{{ comment.text }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No comments yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="../static/js/favorites.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const reviewForm = document.getElementById('reviewForm');
  
  reviewForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const reviewText = document.getElementById('reviewText').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const submitBtn = reviewForm.querySelector('button[type=submit]');
    const rating = document.querySelector('select[name=rating]').value; // Get rating
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
    
    try {
      const response = await axios.post('/submit-review/', {
        review: reviewText,
        movie_id: {{ movie.id }},
        rating:rating  // Pass movie ID from template
      }, {
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      });
      
      // Clear form and show success message
      document.getElementById('reviewText').value = '';
      document.getElementById('reviewMessage').innerHTML = `
        <div class="alert alert-success mt-3">Review submitted successfully!</div>
      `;
      if (response.data.status === 'success') {
        location.reload();
      
    } catch (error) {
      document.getElementById('reviewMessage').innerHTML = `
        <div class="alert alert-danger mt-3">Error: ${error.response?.data?.error || 'Failed to submit review'}</div>
      `;
    } finally {
      // Reset button
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Submit Review';
      
      // Remove message after 5 seconds
      setTimeout(() => {
        document.getElementById('reviewMessage').innerHTML = '';
      }, 5000);
    }
  });
});
</script>
{% endblock %}
