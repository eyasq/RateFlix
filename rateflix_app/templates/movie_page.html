{% extends 'base.html' %}
{% block title %}Movie Details{% endblock %}
{% block content %}
<style>
    .favorite-btn {
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    padding: 5px 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.favorite-btn.favorited {
    background-color: #ffdb58;
    color: #333;
    border-color: #ffc107;
}
</style>
<div class="container mt-4">
  <div class="row">
    <div class="col-md-4 mb-4">
      <div class="card">
        <img src="https://image.tmdb.org/t/p/w600_and_h900_bestv2/{{ movie.poster_path }}" class="card-img-top" alt="{{ movie.title }}">
        <div class="card-body">
          <small class="text-muted">{{ movie.release_date|slice:":4" }}</small>
          <h4 class="card-title">{{ movie.title }}</h4>
          <p><strong>ID:</strong> {{ movie.id }}</p>
          <p class="card-text">{{ movie.overview }}</p>

          {% if user.is_authenticated %}
            {% if movie.id in user_favorite_ids %}
              <button class="btn btn-warning mt-2" disabled>★ Favorited</button>
            {% else %}
              <form method="POST" action="#">
                {% csrf_token %}
                {% if movie.id in user_favorites %}
                <button type="submit" class="btn mt-2 favorite-btn favorited" data-movie-id="{{movie.id}}" data-movie-title="{{movie.title}}" data-movie-poster="{{movie.poster_path}}">★ Favorited</button>
              {% else %}
              <button type="submit" class="btn mt-2 favorite-btn" data-movie-id="{{movie.id}}" data-movie-title="{{movie.title}}" data-movie-poster="{{movie.poster_path}}">★ Add to Favorites</button>
              {% endif %}
 
              </form>
            {% endif %}
          {% endif %}
          <!-- add to favorites logic -> should be done using AJAX. When a user adds a movie to the favorites, check if a movice instance exists in DB, if not, make one, then add the movie instance to the users favorites. must add javascript code for async handling no refresh, and a view function to handle this. -->
        </div>
      </div>
    </div>

    <div class="col-md-8 mb-4">
      {% if user.is_authenticated %}
        <h5>Add a Review</h5>
        <form method="POST" action="">
          {% csrf_token %}
          <div class="form-group mb-2">
            <textarea name="review" class="form-control" rows="3" placeholder="Write your review..."></textarea>
          </div>
          <button type="submit" name="submit_review" class="btn btn-primary">Submit Review</button>
        </form>
        <hr>
      {% endif %}

      <h5>Reviews</h5>
      <div>
        {% if reviews %}
          {% for review in reviews %}
            <div class="border p-2 rounded mb-2">
              <strong>{{ review.user.username }}</strong>:
              <p class="mb-0">{{ review.text }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No reviews yet.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <h4>Top Cast</h4>
      <div class="row">
        {% for actor in cast %}
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
          <div class="card h-100 text-center">
            {% if actor.profile_path %}
              <img src="https://image.tmdb.org/t/p/w300{{ actor.profile_path }}" class="card-img-top" alt="{{ actor.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x450?text=No+Image" class="card-img-top" alt="{{ actor.name }}">
            {% endif %}
            <div class="card-body p-2">
              <h6 class="card-title mb-1">{{ actor.name }}</h6>
              <p class="card-text text-muted mb-0" style="font-size: 0.8rem;">{{ actor.character }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <h4>Comments</h4>

      {% if user.is_authenticated %}
        <form method="POST" action="">
          {% csrf_token %}
          <div class="form-group mb-2">
            <textarea name="comment" class="form-control" rows="2" placeholder="Add a comment..."></textarea>
          </div>
          <button type="submit" name="submit_comment" class="btn btn-secondary">Post Comment</button>
        </form>
        <hr>
      {% endif %}

      <div>
        {% if comments %}
          {% for comment in comments %}
            <div class="border p-2 rounded mb-2">
              <strong>{{ comment.user.username }}</strong>:
              <p class="mb-0">{{ comment.text }}</p>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No comments yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const favoriteButtons = document.querySelectorAll('.favorite-btn');
    
    favoriteButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            // data = name
            const movieId = this.getAttribute('data-movie-id');
            const movieTitle = this.getAttribute('data-movie-title');
            const moviePoster = this.getAttribute('data-movie-poster');
            
            // this object, we will send data to the backend using it
            const movieData = {
                api_id: movieId,
                title: movieTitle,
                poster_url: moviePoster ? `https://image.tmdb.org/t/p/w500${moviePoster}` : null
            };
            
            // grab csrf token so request isnt denied by django
            const form = this.closest('form');
            const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            // add it to axios
            axios.defaults.headers.common['X-CSRFToken'] = csrfToken;
            
            // make an xios post req
            axios.post('/add_to_favorites/', movieData)
                .then(response => {
                    // if success
                    if (response.data.status === 'success') {
                        // Change button appearance to indicate the movie is now favorited
                        this.classList.add('favorited');
                        this.textContent = '★ Favorited';
                        
                        // debug
                        console.log('Movie added to favorites successfully!');
                    } else if (response.data.status === 'removed') {
                        // if success, but already added, remove
                        this.classList.remove('favorited');
                        this.textContent = '★ Add to Favorites';
                        
                        console.log('Movie removed from favorites!');
                    }
                })
                .catch(error => {
                    console.error('Error adding movie to favorites:', error);
                    
                    if (error.response && error.response.data.error) {
                        console.error(error.response.data.error);
                    }
                });
        });
    });
});

</script>

{% endblock %}
